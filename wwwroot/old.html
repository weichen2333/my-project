<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>灌河大桥 - 远程监控平台 (模拟)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #1a1a1a;
            color: #f0f0f0;
            margin: 20px;
        }

        .container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .module {
            background-color: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

            .module h2 {
                margin-top: 0;
                color: #4e9af1;
                border-bottom: 2px solid #444;
                padding-bottom: 10px;
            }

            .module h3 {
                color: #f0f0f0;
                margin-bottom: 5px;
                font-size: 1.1em;
            }

        /* --- ↓↓↓ 新增样式 ↓↓↓ --- */
        #feedbackBar {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 12px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            display: none; /* 默认隐藏 */
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }

        .feedback-success {
            background-color: #28a745;
        }

        .feedback-error {
            background-color: #dc3545;
        }

        .control-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

            .control-buttons button {
                flex-grow: 1;
                padding: 10px;
                font-size: 1em;
                font-weight: bold;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                background-color: #4e9af1;
                color: white;
            }

                .control-buttons button.stop {
                    background-color: #dc3545;
                }

                .control-buttons button:hover {
                    opacity: 0.8;
                }
        /* --- ↑↑↑ 新增样式 ↑↑↑ --- */

        #connectionStatus {
            font-weight: bold;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }

        .status-disconnected {
            background-color: #6b211e;
            color: #fce8e6;
        }

        .status-connected {
            background-color: #1e4d2b;
            color: #e6f4ea;
        }

        .data-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .data-item span:first-child {
            font-weight: 600;
            color: #aaa;
        }

        .data-item span:last-child {
            font-weight: bold;
            color: #fff;
        }

        ul {
            padding-left: 20px;
            max-height: 200px;
            overflow-y: auto;
            background-color: #1a1a1a;
            border: 1px solid #444;
        }

        li {
            list-style-type: none;
            padding: 5px;
            border-bottom: 1px solid #333;
        }

            li:last-child {
                border-bottom: none;
            }
    </style>
</head>
<body>

    <h1>灌河大桥 - 远程监控平台 (模拟)</h1>

    <div id="feedbackBar"></div>
    <div id="connectionStatus" class="status-disconnected">正在连接到服务器...</div>

    <div class="container">

        <div class="module">
            <h2>远程控制 (图 4.1)</h2>
            <h3>检查车 1</h3>
            <div class="control-buttons">
                <button id="btn-start-1">启动 1 号车</button>
                <button id="btn-stop-1" class="stop">停止 1 号车</button>
            </div>
            <div class="control-buttons">
                <button id="btn-fwd-1" style="background-color: #007bff;">前进</button>
                <button id="btn-rev-1" style="background-color: #007bff;">后退</button>
            </div>

            <h3>模拟真实 PLC 写入 (测试 Swagger API)</h3>
            <div class="control-buttons">
                <button id="btn-test-m100-on">写入 M3000 = 1</button>
                <button id="btn-test-m100-off" class="stop">写入 M3000 = 0</button>
            </div>
        </div>
        <div class="module">
            <h2>检查车 1 运行状态 (图 7.2)</h2>
            <div class="data-grid">
                <div class="data-item"><span>速度 (m/s):</span> <span id="status-speed">--</span></div>
                <div class="data-item"><span>电压 (V):</span> <span id="status-voltage">--</span></div>
                <div class="data-item"><span>电流 (A):</span> <span id="status-current">--</span></div>
                <div class="data-item"><span>噪声 (db):</span> <span id="status-noise">--</span></div>
                <div class="data-item"><span>运行时间 (h):</span> <span id="status-runtime">--</span></div>
                <div class="data-item"><span>电量 (%):</span> <span id="status-battery_pct">--</span></div>
            </div>
        </div>

        <div class="module">
            <h2>检查车 1 蓄电池状态 (图 7.6)</h2>
            <div class="data-grid">
                <div class="data-item"><span>电量 (%):</span> <span id="battery-percent">--</span></div>
                <div class="data-item"><span>剩余时间 (h):</span> <span id="battery-worktime">--</span></div>
                <div class="data-item"><span>电压 (V):</span> <span id="battery-voltage">--</span></div>
                <div class="data-item"><span>电流 (A):</span> <span id="battery-current">--</span></div>
                <div class="data-item"><span>温度 (°C):</span> <span id="battery-temp">--</span></div>
            </div>
        </div>

        <div class="module">
            <h2>实时报警记录 (图 7.5)</h2>
            <ul id="alarm-list"><li>(等待报警...)</li></ul>
        </div>
        <div class="module">
            <h2>8台检查车总览 (图 7.7)</h2>
            <ul id="overview-list"><li>(等待数据...)</li></ul>
        </div>
        <div class="module">
            <h2>40路摄像头状态 (图 7.8)</h2>
            <ul id="camera-list"><li>(等待数据...)</li></ul>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>

    <script>
        // 辅助函数
        function updateText(id, text) {
            const el = document.getElementById(id);
            if (el) { el.textContent = text; }
        }

        // --- ↓↓↓ 新增: 反馈栏显示/隐藏逻辑 ↓↓↓ ---
        const feedbackBar = document.getElementById("feedbackBar");
        let feedbackTimer;
        function showFeedback(message, isSuccess) {
            clearTimeout(feedbackTimer); // 清除上一个计时器
            feedbackBar.textContent = message;
            feedbackBar.className = isSuccess ? "feedback-success" : "feedback-error";
            feedbackBar.style.display = "block";

            // 3秒后自动隐藏
            feedbackTimer = setTimeout(() => {
                feedbackBar.style.display = "none";
            }, 3000);
        }
        // --- ↑↑↑ 新增: 反馈栏显示/隐藏逻辑 ↑↑↑ ---


        // --- 步骤 A: 配置连接 ---
        const hubUrl = `${window.location.origin}/bridgeMonitorHub`;
        // (已修改: 自动使用当前页面的地址，不再需要手动改端口)

        const connection = new signalR.HubConnectionBuilder()
            .withUrl(hubUrl)
            .withAutomaticReconnect()
            .build();

        // ... (连接状态显示逻辑不变) ...
        const statusDiv = document.getElementById("connectionStatus");
        connection.onclose(() => { statusDiv.textContent = "已断开连接，正在尝试重连..."; statusDiv.className = "status-disconnected"; });
        connection.onreconnecting(() => { statusDiv.textContent = "正在重连..."; statusDiv.className = "status-disconnected"; });
        connection.onreconnected(() => { statusDiv.textContent = "已成功连接到服务器"; statusDiv.className = "status-connected"; });


        // --- 步骤 B: 监听来自后端的数据 ---

        // ... (所有 "connection.on" 监听器保持不变) ...
        connection.on("ReceiveVehicleStatus", (status) => { /* ... */ });
        connection.on("ReceiveBatteryStatus", (status) => { /* ... */ });
        connection.on("ReceiveAllOverviews", (overviews) => { /* ... */ });
        connection.on("ReceiveCameraInfos", (cameras) => { /* ... */ });
        const alarmList = document.getElementById("alarm-list");
        connection.on("ReceiveAlarm", (alarm) => {
            if (alarmList.firstElementChild && alarmList.firstElementChild.textContent === "(等待报警...)") { alarmList.innerHTML = ""; }
            const li = document.createElement("li");
            li.textContent = `[${new Date(alarm.timestamp).toLocaleTimeString()}] ${alarm.message} (${alarm.duration})`;
            alarmList.prepend(li);
        });

        // --- ↓↓↓ 新增: 监听来自后端的"命令反馈" ↓↓↓ ---
        // 这是我们点击按钮后，等待后端返回的回执
        connection.on("CommandResult", (result) => {
            console.log("收到命令反馈:", result);
            showFeedback(result.message, result.success);
        });
        // --- ↑↑↑ 新增: 监听来自后端的"命令反馈" ↑↑↑ ---


        // --- 步骤 C: 启动连接 ---
        async function start() {
            try {
                await connection.start();
                console.log("SignalR Connected.");
                statusDiv.textContent = "已成功连接到服务器";
                statusDiv.className = "status-connected";

                // --- ↓↓↓ 新增: 连接成功后才绑定控制按钮 ↓↓↓ ---
                bindControlButtons();
                // --- ↑↑↑ 新增: 连接成功后才绑定控制按钮 ↑↑↑ ---

            } catch (err) {
                console.error(err);
                statusDiv.textContent = "连接失败，请检查后端是否运行。";
                statusDiv.className = "status-disconnected";
                setTimeout(start, 5000);
            }
        };

        // --- ↓↓↓ 新增: 绑定按钮点击事件的函数 ↓↓↓ ---
        function bindControlButtons() {
            // 业务逻辑命令 (将由 IPlcService.SendVehicleControlCommand 处理)
            document.getElementById("btn-start-1").addEventListener("click", () => {
                sendVehicleCommand(1, "Start");
            });
            document.getElementById("btn-stop-1").addEventListener("click", () => {
                sendVehicleCommand(1, "Stop");
            });
            document.getElementById("btn-fwd-1").addEventListener("click", () => {
                sendVehicleCommand(1, "Forward");
            });
            document.getElementById("btn-rev-1").addEventListener("click", () => {
                sendVehicleCommand(1, "Reverse");
            });

            // 底层PLC命令 (将由 IPlcService.SendCommandAsync 处理)
            // 注意: 这需要 Web API (Controllers) 来处理, 我们目前是模拟
            document.getElementById("btn-test-m100-on").addEventListener("click", () => {
                // 这个我们暂时用 HTTP Post 来模拟 (对应 Swagger API)
                sendHttpCommand("M100", 1);
            });
            document.getElementById("btn-test-m100-off").addEventListener("click", () => {
                sendHttpCommand("M100", 0);
            });
        }

        // 辅助函数: 发送 SignalR 业务命令
        async function sendVehicleCommand(vehicleId, command) {
            try {
                console.log(`发送业务命令: ${command} 到车辆 ${vehicleId}`);
                await connection.invoke("SendVehicleCommand", vehicleId, command);
            } catch (err) {
                console.error(err);
                showFeedback("发送命令失败 (JS Error)", false);
            }
        }

        // 辅助函数: 发送 HTTP PLC 底层命令 (模拟 Swagger)
        async function sendHttpCommand(register, value) {
            try {
                console.log(`发送HTTP命令: ${register} = ${value}`);
                const response = await fetch(`${window.location.origin}/api/VehicleControl/command`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ register: register, value: value })
                });

                const result = await response.json();
                if (response.ok) {
                    showFeedback(result.message, true);
                } else {
                    showFeedback(result.message, false);
                }
            } catch (err) {
                console.error(err);
                showFeedback("发送 HTTP 命令失败 (JS Error)", false);
            }
        }
        // --- ↑↑↑ 新增: 绑定按钮点击事件的函数 ↑↑↑ ---

        start();
    </script>
</body>
</html>